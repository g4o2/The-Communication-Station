<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Communication Station</title>
    <link rel="stylesheet" href="./styles/style.css">
</head>

<body>
    <div class="container">
        <div class="box box-1">
            <ul id="users">
                <li>
                    <img src="./assets/images/default-user.png" alt="Profile picture for username">
                    <span>username</span>
                </li>
            </ul>
        </div>
        <div class="box box-2">
            <div id="messages">
                <div class="message-container">
                    <img class="message-sender-pfp" src="./assets/images/default-user.png"
                        alt="Profile picture for g4o2">
                    <div class="message-content">
                        <div class="message-header">
                            <span class="message-sender">g4o2</span>
                            (<time class="message-datetime" datetime="2022-11-04T16:33:55Z">Fri, 04 Nov 2022 16:33:55
                                +0000</time>)
                        </div>
                        <div class="message-body">
                            <span class="message">a random message</span>
                        </div>
                    </div>
                </div>
                <div class="message-container">
                    <img class="message-sender-pfp" src="./assets/images/default-user.png" alt="Profile picture for g4o2">
                    <div class="message-content">
                        <div class="message-header">
                            <span class="message-sender">g4o2</span>
                            (<time class="message-datetime" datetime="2022-11-04T16:33:55Z">Fri, 04 Nov 2022 16:33:55
                                +0000</time>)
                        </div>
                        <div class="message-body">
                            <span class="message">a random message</span>
                        </div>
                    </div>
                </div>
            </div>
            <form id="message-form">
                <input type="text" id="message-input" placeholder="Type your message...">
                <button type="submit" id="submit">Send</button>
            </form>
        </div>
        <div class="box box-3">
            <p>&copy; <span id="footer-year">2023</span> The Communication Station. All rights reserved.</p>
        </div>
    </div>
    <script src="./scripts/index.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const messages = document.getElementById('messages');
        const form = document.getElementById('message-form');
        const input = document.getElementById('message-input');
        const submitBtn = document.getElementById('submit');
        let usernametemp = "";

        do {
            usernametemp = prompt('Username');
        } while (usernametemp.match(/[^a-zA-Z0-9_]+/g) || usernametemp == "")
        if (usernametemp) {
            socket.emit('user-connect', usernametemp);
        }

        const username = usernametemp;

        function chatScroll() {
            messages.scrollTop = messages.scrollHeight;
        }

        function escapeHtml(text) {
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/'/g, "&#x27;")
                .replace(/"/g, "&quot;");
        }

        socket.on('user-connect', function (username) {
            let user = new User(username);
            user.setup();
        })

        socket.on('message-submit', function (messageDetails) {
            if(Math.abs(messages.scrollHeight - messages.scrollTop - messages.clientHeight) < 1) {
                const test = new Message(messageDetails.username, messageDetails.date, messageDetails.message);
                test.appendMessage();
                chatScroll()
            } else {
                const test = new Message(messageDetails.username, messageDetails.date, messageDetails.message);
                test.appendMessage();
            }
        });

        form.addEventListener('submit', function (e) {
            e.preventDefault();
            if (input.value) {
                let date = new Date().toUTCString();
                let message = input.value;
                messageDetails = {
                    username: username,
                    date: date,
                    message: input.value
                }
                socket.emit('message-submit', messageDetails);
                input.value = '';
            }
        });

        window.addEventListener("keydown", event => {
            if ((event.keyCode == 191)) {
                if (input === document.activeElement) {
                    return;
                } else {
                    input.focus();
                    input.select();
                    event.preventDefault();
                }
            }
            if ((event.keyCode == 27)) {
                if (input === document.activeElement) {
                    document.activeElement.blur();
                    window.focus();
                    event.preventDefault();
                }
            }
        });
    </script>
</body>

</html>